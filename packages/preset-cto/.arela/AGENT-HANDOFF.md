# Agent Handoff Protocol

## Overview

When an agent hits session limits or fails, Arela automatically handles the handoff to ensure zero work is lost.

## Session Limit Detection

### Triggers
- **Token limit reached** - Agent hits context window limit
- **Rate limit hit** - API throttling
- **Timeout** - Agent unresponsive for > 5 minutes
- **Error threshold** - 3+ consecutive errors
- **Cost limit** - Exceeds budget threshold

### Auto-Detection

```json
{
  "session_limits": {
    "codex": {
      "max_tokens": 100000,
      "max_duration_minutes": 30,
      "max_cost": 1.00
    },
    "claude": {
      "max_tokens": 200000,
      "max_duration_minutes": 60,
      "max_cost": 5.00
    }
  }
}
```

---

## Handoff Strategies

### Strategy 1: Pause & Resume (Default)

**When:** Session limit reached but work is salvageable

**Process:**
1. **Capture state** - Save all progress to handoff file
2. **Pause ticket** - Mark as `paused` with reason
3. **Notify user** - Show what was completed
4. **Wait for resume** - User reviews and continues

**Example:**
```bash
âš  CODEX-001 hit session limit (95K/100K tokens)

Progress saved:
âœ“ Created 8/14 components
âœ“ All tests passing
âœ“ Documentation complete

Next steps:
1. Review progress in .arela/handoffs/CODEX-001.md
2. Resume with: npx arela resume CODEX-001
3. Or reassign with: npx arela reassign CODEX-001 --agent=codex-2
```

### Strategy 2: Auto-Reassign (Aggressive)

**When:** Work can continue with different agent

**Process:**
1. **Capture state** - Save progress + context
2. **Select new agent** - Same type or upgrade
3. **Generate handoff brief** - What's done, what's left
4. **Auto-continue** - New agent picks up where old left off

**Example:**
```bash
âš  CODEX-001 hit session limit

Auto-reassigning to CODEX-002...
âœ“ Handoff brief generated
âœ“ CODEX-002 started with context
âœ“ Continuing from component 9/14
```

### Strategy 3: Escalate (Smart)

**When:** Task is too complex for current agent

**Process:**
1. **Detect complexity** - Agent struggling (multiple retries)
2. **Escalate to better agent** - Codex â†’ Claude
3. **Preserve context** - Full handoff with learnings
4. **Continue with upgrade** - Better agent finishes

**Example:**
```bash
âš  CODEX-001 failed 3 times on complex auth logic

Escalating to CLAUDE-001...
âœ“ Handoff includes: attempted solutions, error logs
âœ“ CLAUDE-001 analyzing with deeper reasoning
âœ“ Cost increased but quality guaranteed
```

---

## Handoff File Format

### Location
`.arela/handoffs/{TICKET-ID}.md`

### Structure

```markdown
# Handoff: CODEX-001 â†’ CODEX-002

**Original Agent:** @codex (session 1)
**New Agent:** @codex (session 2)
**Reason:** Session limit reached (95K/100K tokens)
**Timestamp:** 2025-11-09T20:45:32Z

## Original Ticket

[Full ticket content]

## Progress Summary

### Completed âœ“
- [x] Created Input component
- [x] Created Button component
- [x] Created Select component
- [x] All unit tests passing
- [x] Storybook stories added

### In Progress âš 
- [ ] Textarea component (50% done)
  - Structure complete
  - Styling needs finishing
  - Tests not written yet

### Not Started âŒ
- [ ] Checkbox component
- [ ] Radio component
- [ ] Switch component
- [ ] Form component
- [ ] Integration tests

## Context for New Agent

### What Works
- Component structure is solid
- Test patterns established
- Storybook setup complete

### What Doesn't
- Textarea resize logic buggy
- Need to handle edge cases better

### Key Decisions Made
- Using Tailwind for styling
- Radix UI for accessibility
- Vitest for testing

### Files Modified
```
packages/react/src/components/ui/
â”œâ”€â”€ input.tsx âœ“
â”œâ”€â”€ button.tsx âœ“
â”œâ”€â”€ select.tsx âœ“
â””â”€â”€ textarea.tsx âš  (in progress)
```

### Next Steps (Priority Order)
1. Fix textarea resize logic
2. Add textarea tests
3. Create checkbox component
4. Create radio component
5. Create switch component
6. Create form component
7. Add integration tests

## Learnings & Gotchas

- Textarea needs `resize: vertical` CSS
- Focus management requires `useRef` hook
- Error states need `aria-invalid` attribute
- Tests must check accessibility

## Cost Tracking

**Session 1 (CODEX-001):**
- Tokens used: 95,000
- Cost: $0.190
- Duration: 28 minutes

**Estimated Remaining:**
- Tokens: ~60,000
- Cost: ~$0.120
- Duration: ~20 minutes

**Total Estimated:**
- Cost: $0.310
- Duration: 48 minutes

## Resume Command

```bash
# Continue with new session
npx arela resume CODEX-001

# Or reassign to different agent
npx arela reassign CODEX-001 --agent=claude
```

---

**Generated by Arela Agent Handoff System v1.4.0**
```

---

## Configuration

### Enable Handoff

```json
{
  "handoff": {
    "enabled": true,
    "strategy": "pause",  // "pause" | "auto-reassign" | "escalate"
    "auto_resume": false,
    "escalation_rules": {
      "max_retries": 3,
      "escalate_to": {
        "codex": "claude",
        "deepseek": "codex",
        "local-llama": "codex"
      }
    },
    "session_limits": {
      "warn_at_percent": 80,
      "pause_at_percent": 95
    }
  }
}
```

### Per-Agent Limits

```json
{
  "agents": {
    "codex": {
      "max_tokens": 100000,
      "max_duration_minutes": 30,
      "max_cost": 1.00,
      "handoff_strategy": "auto-reassign"
    },
    "claude": {
      "max_tokens": 200000,
      "max_duration_minutes": 60,
      "max_cost": 5.00,
      "handoff_strategy": "pause"
    }
  }
}
```

---

## CLI Commands

### Resume Paused Ticket

```bash
# Resume with same agent type (new session)
npx arela resume CODEX-001

# Resume with specific agent
npx arela resume CODEX-001 --agent=codex-2

# Resume with different agent type
npx arela resume CODEX-001 --agent=claude
```

### Reassign Ticket

```bash
# Reassign to different agent
npx arela reassign CODEX-001 --agent=claude

# Reassign with reason
npx arela reassign CODEX-001 --agent=claude --reason="Too complex for Codex"
```

### View Handoffs

```bash
# List all handoffs
npx arela handoffs

# View specific handoff
npx arela handoff CODEX-001

# View handoff history
npx arela handoff CODEX-001 --history
```

---

## Monitoring

### Session Health

```bash
npx arela status --sessions

# Output:
CODEX-001: 85K/100K tokens (85%) âš  Warning
CLAUDE-001: 45K/200K tokens (22%) âœ“ Healthy
CODEX-002: 12K/100K tokens (12%) âœ“ Healthy
```

### Auto-Warnings

```bash
âš  CODEX-001 at 80% token limit (80K/100K)
  - Consider pausing soon
  - Or enable auto-handoff

âš  CODEX-001 at 95% token limit (95K/100K)
  - Auto-pausing in 5K tokens
  - Handoff file will be generated
```

---

## Best Practices

### 1. Enable Warnings Early

```json
{
  "session_limits": {
    "warn_at_percent": 70,  // Warn early
    "pause_at_percent": 90   // Pause before hard limit
  }
}
```

### 2. Use Auto-Reassign for Simple Tasks

```json
{
  "codex": {
    "handoff_strategy": "auto-reassign"  // Safe for CRUD
  }
}
```

### 3. Use Pause for Complex Tasks

```json
{
  "claude": {
    "handoff_strategy": "pause"  // Review before continuing
  }
}
```

### 4. Enable Escalation for Quality

```json
{
  "escalation_rules": {
    "max_retries": 2,  // Escalate quickly
    "escalate_to": {
      "codex": "claude"  // Upgrade when stuck
    }
  }
}
```

---

## Error Recovery

### Scenario 1: Agent Crashes Mid-Task

```bash
âš  CODEX-001 crashed (connection lost)

Auto-recovery:
âœ“ Progress saved to handoff file
âœ“ Ticket marked as 'failed'
âœ“ Handoff available for resume

Resume with:
npx arela resume CODEX-001
```

### Scenario 2: Rate Limit Hit

```bash
âš  CODEX-001 rate limited (429 error)

Auto-recovery:
âœ“ Paused ticket
âœ“ Will retry in 60 seconds
âœ“ Or reassign to different agent

Options:
1. Wait: npx arela wait CODEX-001
2. Reassign: npx arela reassign CODEX-001 --agent=codex-2
```

### Scenario 3: Cost Limit Exceeded

```bash
âš  CODEX-001 exceeded cost limit ($1.05 > $1.00)

Auto-recovery:
âœ“ Paused ticket
âœ“ Progress saved
âœ“ Cost report generated

Options:
1. Increase limit: npx arela set-limit CODEX-001 --cost=2.00
2. Reassign to cheaper: npx arela reassign CODEX-001 --agent=deepseek
3. Use local: npx arela reassign CODEX-001 --agent=local-llama
```

---

## Integration with Status Tracking

### Status Values

```json
{
  "status": "paused",  // New status
  "paused_reason": "session_limit",
  "paused_at": "2025-11-09T20:45:32Z",
  "handoff_file": ".arela/handoffs/CODEX-001.md",
  "resumable": true,
  "suggested_agent": "codex"
}
```

### Handoff History

```json
{
  "handoffs": [
    {
      "from": "codex-session-1",
      "to": "codex-session-2",
      "reason": "session_limit",
      "timestamp": "2025-11-09T20:45:32Z",
      "progress_percent": 60
    }
  ]
}
```

---

## Future Enhancements (v2.0)

- **Smart context compression** - Summarize old context to fit new session
- **Multi-agent collaboration** - Multiple agents work together
- **Streaming handoffs** - Real-time progress sharing
- **Agent voting** - Multiple agents review and vote on solutions
- **Cost prediction** - Estimate if ticket will hit limits

---

## Example: Real-World Handoff

```bash
# Start ticket
npx arela run-ticket codex CODEX-001

# Agent works...
[Progress: 60%]
[Tokens: 85K/100K] âš  Warning

# Continue working...
[Progress: 70%]
[Tokens: 95K/100K] âš  Critical

# Auto-pause triggered
âš  CODEX-001 paused at 95% token limit

Handoff Summary:
âœ“ 10/14 components completed
âœ“ All tests passing
âœ“ 4 components remaining

Handoff file: .arela/handoffs/CODEX-001.md

Resume with:
npx arela resume CODEX-001

# User reviews handoff file
cat .arela/handoffs/CODEX-001.md

# Resume with new session
npx arela resume CODEX-001

# New agent continues
[Progress: 70% â†’ 100%]
[Tokens: 0K â†’ 45K]

âœ“ CODEX-001 completed
  Total cost: $0.310
  Total time: 48 minutes
  Sessions: 2
```

---

**Zero work lost. Maximum efficiency. Production-ready handoffs.** ðŸ”„
