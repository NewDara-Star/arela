# Slice Extraction (v4.0.0)

The slice extraction feature is the crown jewel of Arela v4.0.0. It automatically transforms your horizontally-organized codebase into a clean, vertical slice architecture with a single command.

## Overview

Instead of organizing code by technical layers (controllers, services, repositories), slice extraction organizes code by business features or domains. This reduces coupling, improves team ownership, and makes codebases easier to understand and maintain.

```
# Before: Horizontal/Layered Architecture
src/
â”œâ”€â”€ controllers/      (all controllers)
â”œâ”€â”€ services/         (all services)
â”œâ”€â”€ repositories/     (all repos)
â””â”€â”€ utils/            (all utilities)

# After: Vertical Slice Architecture
features/
â”œâ”€â”€ authentication/
â”‚   â”œâ”€â”€ login.ts
â”‚   â”œâ”€â”€ logout.ts
â”‚   â””â”€â”€ types.ts
â”œâ”€â”€ user-profile/
â”‚   â”œâ”€â”€ get-profile.ts
â”‚   â”œâ”€â”€ update-profile.ts
â”‚   â””â”€â”€ types.ts
â””â”€â”€ ...
```

## Quick Start

### 1. Extract All Slices

```bash
arela refactor extract-all-slices
```

This command will:
1. Detect slices in your codebase (using v3.8.0 detection)
2. Create a `features/` directory with each slice as a subdirectory
3. Move all files to their respective slice directories
4. Update all import paths automatically
5. Run tests to verify nothing broke
6. Create git commits for each slice

### 2. Preview Changes (Dry Run)

```bash
arela refactor extract-all-slices --dry-run
```

See what would be extracted without making changes.

### 3. Extract a Specific Slice

```bash
arela refactor extract-slice authentication
```

Extract only the "authentication" slice.

### 4. Skip Test Verification

```bash
arela refactor extract-all-slices --skip-tests
```

Extract slices without running tests (faster but riskier).

## Command Options

### Global Options

| Option | Description | Default |
|--------|-------------|---------|
| `--dry-run` | Preview without making changes | false |
| `--skip-tests` | Skip test verification | false |
| `--interactive` | Ask for confirmation | false |
| `--min-cohesion <n>` | Only extract slices above cohesion % | 70 |
| `--cwd <dir>` | Working directory | current |
| `--verbose` | Show detailed output | false |

## How It Works

### 1. Slice Detection

Arela uses the Infomap clustering algorithm (from v3.8.0) to detect natural boundaries in your dependency graph. A slice is a cohesive group of files that:

- Have high internal cohesion (files within the slice import each other frequently)
- Have low external coupling (minimal dependencies on other slices)
- Represent a single business domain or feature

### 2. File Movement

Once slices are identified, Arela creates the `features/` directory structure and moves files:

```
src/auth/login.ts â†’ features/authentication/auth/login.ts
src/auth/logout.ts â†’ features/authentication/auth/logout.ts
```

File structure within slices is preserved to maintain any organizational logic.

### 3. Import Path Updates

This is the most complex part. Arela:

1. Parses all import statements in your project
2. Identifies which imports refer to files that moved
3. Calculates new relative paths
4. Updates all imports automatically

**Example:**
```typescript
// Before
import { theme } from '../utils/theme';

// After (if utils moved to shared/)
import { theme } from '../../shared/utils/theme';
```

Supports:
- ES Modules (`import...from`)
- CommonJS (`require()`)
- TypeScript (`import type...from`)
- Python (`import...from`)
- Go (`import "..."`)

### 4. Test Verification

Arela automatically detects and runs your test framework:

- **Vitest** - `vitest run`
- **Jest** - `jest`
- **Mocha** - `mocha`
- **Pytest** - `pytest`

If tests fail, extraction is rolled back automatically.

### 5. Git Commits

Each slice is committed with a clear message:

```
feat: extract authentication slice

- Moved 12 files
- Updated imports: 45 internal, 12 external
- Cohesion score: 85%

Generated by Arela v4.0.0
```

## Example Output

```
ğŸš€ Arela v4.0.0 - Slice Extraction

ğŸ” Detecting slices...
âœ… Found 8 slices with high quality

ğŸ“‹ Creating extraction plan...

  ğŸ” authentication (12 files, 45 imports)
  ğŸ’ª workout (23 files, 89 imports)
  ğŸ nutrition (18 files, 67 imports)
  ğŸ‘¥ social (15 files, 54 imports)
  ğŸ¨ ui-components (31 files, 102 imports)
  ğŸ”§ utils (8 files, 12 imports)
  ğŸ’¾ database (14 files, 58 imports)
  âš™ï¸ config (6 files, 8 imports)

  Total: 127 files, 435 imports
  Estimated time: ~45s

ğŸš€ Starting extraction...

[1/8] ğŸ” Extracting authentication...
  ğŸ“ Moving 12 files...
  âœ… Moved to features/authentication/
  ğŸ”— Updating 45 imports...
  âœ… All imports updated
  âœ… Committed: Extract authentication slice

[2/8] ğŸ’ª Extracting workout...
  ğŸ“ Moving 23 files...
  âœ… Moved to features/workout/
  ğŸ”— Updating 89 imports...
  âœ… All imports updated
  âœ… Committed: Extract workout slice

... (6 more slices)

ğŸ§ª Running tests...
âœ… All tests passed (247/247)

ğŸ‰ Extraction complete!
  - 8 slices extracted
  - 127 files moved
  - 435 imports updated
  - 8 commits created
  - 0 tests broken

Your architecture is now vertical! ğŸ¯
```

## Architecture Details

### Module Structure

```
src/refactor/
â”œâ”€â”€ types.ts              # Type definitions
â”œâ”€â”€ file-mover.ts        # File system operations
â”œâ”€â”€ import-updater.ts    # Import path rewriting
â”œâ”€â”€ test-runner.ts       # Test detection and execution
â”œâ”€â”€ git-manager.ts       # Git operations
â”œâ”€â”€ slice-extractor.ts   # Main orchestrator
â””â”€â”€ index.ts             # Module exports
```

### Key Classes

#### `SliceExtractor`

Main orchestrator for the entire extraction process.

```typescript
const extractor = new SliceExtractor();
const result = await extractor.extractAllSlices({
  dryRun: false,
  skipTests: false,
  minCohesion: 70,
  cwd: process.cwd(),
});
```

#### `FileMover`

Handles file system operations.

```typescript
const mover = new FileMover();
const movements = await mover.planFileMovement(slice, cwd);
await mover.moveFiles(movements, dryRun);
await mover.cleanupEmptyDirs(cwd);
```

#### `ImportUpdater`

Handles import path updates.

```typescript
const updater = new ImportUpdater();
updater.buildFileMapping(plans, cwd);
const updates = await updater.planImportUpdates(plans, cwd);
await updater.updateImports(updates, dryRun, cwd);
```

#### `TestRunner`

Handles test detection and execution.

```typescript
const runner = new TestRunner();
const framework = await runner.detectTestFramework(cwd);
const result = await runner.runTests(cwd);
```

#### `GitManager`

Handles git operations.

```typescript
const git = new GitManager();
await git.stageFiles(filePaths, cwd);
await git.commitSlice(slice, stagedFiles, cwd);
```

## Best Practices

### 1. Commit Before Extraction

Always ensure your working directory is clean before extraction:

```bash
git status  # Should show clean working tree
git add .
git commit -m "Save work before refactoring"
```

Arela will refuse extraction if there are uncommitted changes.

### 2. Use Dry Run First

Always preview the changes before actually extracting:

```bash
arela refactor extract-all-slices --dry-run
```

### 3. Review Quality Metrics

Check slice cohesion scores before extraction:

```bash
arela detect slices --verbose
```

Only slices with 70%+ cohesion are extracted by default. You can adjust this:

```bash
arela refactor extract-all-slices --min-cohesion 75
```

### 4. Keep Tests Passing

Ensure all tests pass before extraction:

```bash
npm test
arela refactor extract-all-slices  # Will verify tests still pass
```

### 5. Use Git for Safety

Slice extraction creates git commits automatically. If something goes wrong, you can rollback:

```bash
git log --oneline  # See extraction commits
git reset --hard HEAD~8  # Rollback 8 slice extractions
```

## Rollback

If extraction fails or produces unexpected results, Arela automatically rolls back:

```bash
# Extraction failed, automatic rollback occurred
# No commits were created
# Files are restored to original locations
# Imports are restored to original paths
```

You can also manually rollback using git:

```bash
# See recent commits
git log --oneline | head

# Rollback to before extraction
git reset --hard <commit-hash>
git clean -fd
```

## Troubleshooting

### Tests Fail After Extraction

This usually indicates an import path was calculated incorrectly. Check:

1. The error message for which tests failed
2. The import statements in failing test files
3. Whether the imported modules exist in their new locations

```bash
# Re-run with verbose output to see import changes
arela refactor extract-all-slices --verbose
```

### Missing or Incorrect Slice Detection

If slices aren't being detected or are poorly defined:

1. Re-ingest your codebase to update the dependency graph:

```bash
arela ingest codebase
```

2. Check detection results:

```bash
arela detect slices --verbose
```

3. Consider adjusting cohesion threshold:

```bash
arela refactor extract-all-slices --min-cohesion 60  # Lower threshold
```

### Import Paths Still Incorrect

If some imports weren't updated correctly:

1. Check the file extension (TypeScript, JavaScript, Python, Go imports are all parsed differently)
2. Check for special import patterns (barrel exports, path aliases, monorepo imports)
3. Run a search for the old import path:

```bash
grep -r "from './auth/login'" src/  # Should be empty after extraction
```

## Performance Considerations

Extraction time depends on:

- **Codebase size** - Number of files and imports to process
- **Project complexity** - More interdependencies = longer processing
- **Test suite** - Most time spent running tests

**Rough estimates:**
- Small project (50-100 files): 10-15 seconds
- Medium project (200-500 files): 30-60 seconds
- Large project (1000+ files): 2-5 minutes

Most time is spent:
1. Updating imports (~15%)
2. Running tests (~70%)
3. Moving files (~5%)
4. Creating commits (~10%)

To speed up testing, use `--skip-tests`, but be cautious:

```bash
arela refactor extract-all-slices --skip-tests  # Faster but riskier
```

## Supported Languages

Import path updates work for:

- âœ… **TypeScript** (.ts, .tsx)
- âœ… **JavaScript** (.js, .jsx)
- âœ… **Python** (.py)
- âœ… **Go** (.go)

Other languages may require manual import updates or additional tooling.

## Advanced Usage

### Extract Slices Programmatically

```typescript
import { SliceExtractor } from 'arela';

const extractor = new SliceExtractor();
const result = await extractor.extractAllSlices({
  dryRun: false,
  skipTests: false,
  minCohesion: 70,
  cwd: '/path/to/project',
  verbose: true,
});

if (result.success) {
  console.log(`Extracted ${result.extractedSlices} slices`);
  console.log(`Moved ${result.movedFiles} files`);
  console.log(`Updated ${result.updatedImports} imports`);
} else {
  console.error('Extraction failed:', result.errors);
}
```

### Custom Extraction Plans

Combine with other Arela tools:

```bash
# 1. Detect slices with custom parameters
arela detect slices --min-cohesion 80 --json slices.json

# 2. Manually review/edit slices.json

# 3. Use edited slices for extraction
# (Note: This feature is planned for v4.1.0)
```

## Common Patterns

### Shared Code

Some code (utilities, types, constants) might be used by multiple slices. Arela automatically:

1. Detects heavily-used code (high in-degree)
2. Keeps it in `shared/` or `common/` directory
3. Updates all imports to reference the shared location

### Barrel Exports

If slices use barrel exports (index.ts), Arela preserves them:

```
features/auth/
â”œâ”€â”€ index.ts          # export * from './login'
â”œâ”€â”€ login.ts
â””â”€â”€ logout.ts
```

### Configuration Files

Configuration files (config.json, environment.ts, etc.) are typically shared and kept at the root or in `shared/config/`.

## Future Enhancements (v4.1+)

- [ ] Interactive mode to review/edit slices before extraction
- [ ] Custom extraction plans from JSON
- [ ] Python and Go slice extraction (currently TypeScript/JavaScript focus)
- [ ] Automatic shared code detection and organization
- [ ] Slice dependency visualization
- [ ] Migration guides for moving between architectures
- [ ] Monorepo support with workspace organization

## Support

For issues or questions:

1. Check the troubleshooting section above
2. Run in verbose mode: `arela refactor extract-all-slices --verbose`
3. Review the git commits: `git log --stat`
4. File an issue: https://github.com/anthropics/arela/issues

## See Also

- [Slice Detection](./detection.md) - How slices are detected
- [Architecture Analysis](./architecture.md) - Analyzing your codebase structure
- [CLI Reference](./cli.md) - All available commands
