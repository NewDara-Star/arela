name: Arela Doctor
on: [pull_request]

jobs:
  doctor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node + pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: corepack enable
      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install deps
        run: pnpm install

      - name: Build Arela CLI (monorepo)
        run: pnpm -F @newdara/preset-cto build

      - name: Run Arela Doctor
        run: |
          set -e
          if [ -f node_modules/@newdara/preset-cto/dist/cli.js ]; then
            node node_modules/@newdara/preset-cto/dist/cli.js doctor --eval
          elif [ -f node_modules/@arela/preset-cto/dist/cli.js ]; then
            node node_modules/@arela/preset-cto/dist/cli.js doctor --eval
          elif [ -f packages/preset-cto/dist/cli.js ]; then
            node packages/preset-cto/dist/cli.js doctor --eval
          else
            echo "Arela CLI not found (tried @newdara, @arela, monorepo path). Did the build step run?" >&2
            ls -la packages/preset-cto || true
            exit 1
          fi
